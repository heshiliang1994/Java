https://blog.csdn.net/claram/article/details/90265243

https://www.ucloud.cn/yun/34942.html

在分布式系统中，为了实现系统的高性能、高并发、高可用，在构架中都会进行负载均衡设计，它是分布式系统的核心和中枢，负载均衡的好坏直接影响着整个系统的性能。负载均衡分为软件均衡和硬件均衡两类，比如apache、nginx、dubbo 等属于软件负载均衡，F5属于硬件负载均衡，当然他们都会使用到负载均衡算法。

常见的负载均衡算法包含：
1、轮询法（Round Robin）
2、加权轮询法（Weight Round Robin）
3、随机法（Random）
4、加权随机法（Weight Random）
5、平滑加权轮询法（Smooth Weight Round Robin）
6、源地址哈希法（Hash）
7、最小连接数法（Least Connections）

## 一、轮询法

轮询调度（Round Robin Scheduling）算法是以轮询的方式依次将请求调度不同的服务器，即每次调度执行i=(i+1) mod n，并选出第i台服务器。算法的有点是其简洁性，它无需记录当前所有连接的状态，所以它是一种无状态调度。

轮询调度算法的原理是每一次把来自用户的请求轮流分配给内部中的服务器，从1开始，直到N（内部服务器个数），然后重新开始循环。

假设一组服务器N台，S={S1,...,Sn}，一个指示变量i表示上一次选择的服务器ID，变量i被初始化为N-1。一个很经典的算法程序如下：

```java
j = i;
do
{
    j = (j + 1) mod n;
    i = j;
    return Si;
} while (j != i);
return NULL;
```

轮询调度算法假设所有服务器的处理性能都相同，不关心每台服务器的当前连接数和响应速度。当请求服务间隔时间变化比较大时，轮询调度算法很容易导致服务器间的负载不平衡。所以此种均衡算法适合于服务器组中的所有服务器都有相同的软硬件配置并且平均服务请求相对均衡的情况。

## 二、加权轮询法

轮询算法并没有考虑每台服务器的处理能力，实际中可能并不是这种情况。由于每台服务器的配置、安装的业务应用等不同，其处理能力也会不一样。所以，加权轮询算法的原理就是：根据服务器的不同处理能力，给每个服务器分配不同的权值，使其能够接受相应权值数的服务请求。

首先看一个简单的Nginx负载均衡配置：

```
http {  
    upstream cluster {  
        server a weight=1;  
        server b weight=2;  
        server c weight=4;  
    }  
    ...
}
```

按照上述配置，Nginx每收到7个客户端的请求，会把其中的1个转发给后端a，会把其中的2个转发给后端b，把其中的4个转发给后端c。

加权轮询算法的结果，就是要生成一个服务器序列。每当有请求到来时，就依次从该序列中取出下一个服务器用于处理该请求。比如针对上面的例子，加权轮询算法会生成序列{c,c,b,c,a,b,c}。这样，每收到7个客户端的请求，会把其中的1个转发给后端a，把其中的2个转发给后端b，把其中的4个转发给后端c。收到的第8个请求，重新从该序列的头部开始轮询。

总之，加权轮询算法要生成一个服务器序列，该序列中包含n个服务器。n是所有服务器的权重之和。在该序列中，每个服务器的出现的次数，等于其权重值。并且，生成的序列中，服务器的分布应该尽可能的均匀。比如序列{a,a,a,a,a,b,c}，前5个请求都会分配给服务器a，这是一种不均匀的分配方法，更好的序列应该是{a,a,b,a,c,a,a}。

下面介绍两种加权轮询算法：

### 1.普通加权轮询算法

这种算法的原理是：在服务器数组S中，首先计算所有服务器权重的最大值max(S)，以及所有服务器权重的最大公约数gcd(S).

index表示本次请求到来时，选择的服务器的索引，初始值为-1；current_weight表示当前调度的权值，初始值为max(S)。

当请求到来时，从index+1开始轮询服务器数组S，找到其中权重大于current_weight的第一个服务器，用于处理该请求。记录其索引到结果序列中。

再轮询服务器数组时，如果到达了数组末尾，则重新从头开始搜索，并且减小current_weight的值：

### 2.平滑的加权轮询

## 三、随机法

通过随机算法从服务器列表中随机选择一台服务器进行访问。由概率论可以得知，随着客户端调用服务端的次数增多，其实际效果趋近于平均分配请求到服务端的每一台服务器，也就是达到轮询的效果。

## 四、随机加权法

与加权轮询法一样，加权随机法也根据服务器的配置，系统的负载分配不同的权重。不同的是，它是按照权重随机请求后端服务器，而非顺序。

## 五、平滑加权随机法

在加权轮询算法中我们讲到“从宏观的角度讲，权重高的服务器被访问的次数高一些，近似均衡；从微观上讲，权重高的服务器会被连续访问到，看起来没那么均衡”，为了更好的解决均衡的问题，nginx的作者提出了均衡加权轮询算法。

假设有N台服务器S={S1,...,Sn}，默认权重为W={W0,...,Wn}，当前权重为CW={CW0,...,CWn}。在该算法中有两个权重，默认权重表示服务器的原始权重，当前权重表示每次访问后重新计算的权重，当前权重的初始值为默认权重值，当前权重值最大的服务器为maxWeightServer，所有默认权重之和为weightSum，服务器列表为serverList，算法可以描述为：

## 六、源地址哈希法

## 七、最小连接数法

